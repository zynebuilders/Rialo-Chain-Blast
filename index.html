<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rialo Chain Blaster</title>
    <link rel="icon" type="image/png" href="logorlo.png">
    <style>
        /* General Setup */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: #000;
            font-family: 'Courier New', monospace;
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            color: #0f0;
        }

        /* Pre-Splash Screen ("Powered by") */
        #pre-splash {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 102; /* Paling atas */
            opacity: 0; /* Mulai transparan */
            animation: fadeIn 1s ease-out forwards; /* Animasi masuk */
        }

        #pre-splash.hidden {
            /* Animasi keluar */
            animation: fadeOut 5s ease-in forwards;
        }

        .powered-by-text {
            font-size: 24px;
            color: #0f0;
            text-shadow: 0 0 8px #0f0;
            animation: text-flicker 1s linear infinite; /* Efek kelip aesthetic */
        }

        @keyframes fadeIn {
            to { opacity: 1; }
        }

        @keyframes fadeOut {
            to { opacity: 0; pointer-events: none; }
        }

        @keyframes text-flicker {
            0% { opacity: 0.5; }
            5% { opacity: 1; }
            10% { opacity: 0.7; }
            15% { opacity: 1; }
            30% { opacity: 1; }
            35% { opacity: 0.4; }
            40% { opacity: 1; }
            100% { opacity: 1; }
        }

        /* Splash Screen Styles */
        #splash-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 100;
            opacity: 0; /* Awalnya disembunyikan total */
            transition: opacity 1s ease-out;
        }
        
        #splash-screen.visible {
            opacity: 1; /* Muncul saat dipicu JS */
        }

        #splash-screen.hidden {
            opacity: 0;
            pointer-events: none;
        }

        #rialo-logo {
            width: 80%;
            max-width: 400px;
            opacity: 0;
            transform: scale(0.8);
        }

        /* Animasi logo dipicu dengan class .animate */
        #rialo-logo.animate {
            animation: fadeInScale 1.5s ease-out forwards;
        }

        @keyframes fadeInScale {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Desktop Warning */
        #desktop-warning {
            display: none; /* Hidden by default */
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #000;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            padding: 20px;
            z-index: 101;
        }

        /* Game Container */
        #gameContainer {
            position: relative;
            width: 800px;
            height: 600px;
            visibility: hidden; 
            opacity: 0;
            transition: opacity 0.5s ease-in;
        }

        #gameContainer.visible {
            visibility: visible;
            opacity: 1;
        }

        /* Show warning and hide game on small screens */
        @media (max-width: 800px) or (max-height: 600px) {
            #gameContainer {
                display: none;
            }
            #desktop-warning {
                display: flex;
            }
            #splash-screen, #pre-splash {
                display: none;
            }
        }

        #gameCanvas {
            background-color: #000;
            display: block;
            border: 2px solid #333;
        }

        #uiOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        #topUI {
            position: absolute;
            top: 10px;
            width: 100%;
            display: flex;
            justify-content: space-between;
            padding: 0 20px;
            font-size: 18px;
            text-shadow: 0 0 5px #0f0;
        }
        
        /* --- NEW: BOSS UI --- */
        #bossUIContainer {
            position: absolute;
            top: 60px;
            left: 50%;
            transform: translateX(-50%);
            width: 60%;
            text-align: center;
            color: #c000ff; /* Neon Purple */
        }
        
        #bossUIContainer p {
            font-size: 18px;
            margin-bottom: 5px;
            text-shadow: 0 0 8px #c000ff;
            font-weight: bold;
        }
        
        .bossHealthBar {
            width: 100%;
            height: 20px;
            border: 2px solid #9400d3;
            border-radius: 5px;
            overflow: hidden;
            background-color: rgba(50, 0, 80, 0.5);
        }
        
        #bossHealthFill {
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #6a0dad, #c000ff);
            box-shadow: 0 0 10px #c000ff;
            transition: width 0.3s ease-in-out;
        }
        /* --- END: BOSS UI --- */

        .uiBarContainer {
            position: absolute;
            bottom: 20px;
            width: 150px;
            text-align: center;
        }

        .uiBarContainer p {
            font-size: 16px;
            margin-bottom: 5px;
            text-shadow: 0 0 5px;
        }

        #healthContainer {
            left: 150px;
            color: #f00;
        }

        /* --- MODIFIED FOR ULTIMATE SKILL --- */
        #ultimateContainer {
            right: 150px;
            color: #ff8c00; /* Orange color for Ultimate */
        }

        .uiBar {
            width: 100%;
            height: 25px;
            border: 2px solid #555;
            border-radius: 5px;
            overflow: hidden;
            background-color: #222;
        }

        #healthFill {
            width: 100%;
            height: 100%;
            background: linear-gradient(to right, #900, #f00);
            box-shadow: 0 0 10px #f00;
            transition: width 0.3s;
        }

        #ultimateFill {
            width: 0%; /* Start empty */
            height: 100%;
            background: linear-gradient(to right, #e25822, #ff8c00);
            box-shadow: 0 0 10px #ff8c00;
            transition: width 0.3s;
        }
        /* --- END MODIFICATION --- */


        #powerUpUI {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            color: #ff0;
            font-size: 18px;
            text-shadow: 0 0 8px #ff0;
        }
        
        #levelProgressUI {
            position: absolute;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%);
            color: #0f0;
            font-size: 16px;
            text-shadow: 0 0 5px #0f0;
        }
        
        /* --- NEW MENU: USERNAME --- */
        #usernameMenu {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            z-index: 10;
             /* No box styling as requested */
        }

        #game-art {
            max-width: 350px; /* Adjust size as needed */
            margin-bottom: 25px;
        }

        input[type="text"] {
            background-color: rgba(0,0,0,0.5);
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 15px;
            font-size: 18px;
            border-radius: 5px;
            font-family: 'Courier New', monospace;
            display: block;
            margin: 0 auto 20px auto; /* Center and add margin below */
            width: 80%;
            max-width: 300px;
            text-align: center;
            transition: all 0.3s;
        }

        input[type="text"]::placeholder {
            color: #0a0;
            opacity: 0.7;
        }

        input[type="text"]:focus {
            outline: none;
            box-shadow: 0 0 15px #0f0;
        }


        #gameStart, #gameOver {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background-color: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 10px;
            z-index: 10;
        }

        #gameStart {
            border: 2px solid #0f0;
            box-shadow: 0 0 20px #0f0;
        }

        #gameOver {
            border: 2px solid #f00;
            box-shadow: 0 0 20px #f00;
        }

        h1 {
            color: #0f0;
            margin-bottom: 20px;
            font-size: 36px;
            text-shadow: 0 0 10px #0f0;
        }

        #gameStart h1:first-of-type {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 15px;
            animation: pulse-glow-text 2s infinite ease-in-out;
        }

        .h1-logo {
            width: 45px;
            filter: drop-shadow(0 0 10px #0f0);
            animation: pulse-glow-logo 2s infinite ease-in-out;
        }
        
        @keyframes pulse-glow-logo {
            0%, 100% {
                transform: scale(1);
                filter: drop-shadow(0 0 10px #0f0);
            }
            50% {
                transform: scale(1.05);
                filter: drop-shadow(0 0 15px #0f0);
            }
        }
        
        @keyframes pulse-glow-text {
            0%, 100% {
                text-shadow: 0 0 10px #0f0;
            }
            50% {
                text-shadow: 0 0 15px #0f0, 0 0 5px #fff;
            }
        }

        button {
            background-color: #000;
            color: #0f0;
            border: 2px solid #0f0;
            padding: 10px 20px;
            font-size: 18px;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 5px;
            transition: all 0.3s;
            font-family: 'Courier New', monospace;
        }

        button:hover {
            background-color: #0f0;
            color: #000;
            box-shadow: 0 0 15px #0f0;
        }

        #instructions {
            margin-top: 20px;
            color: #0f0;
            font-size: 14px;
            line-height: 1.5;
        }

        .hidden {
            display: none;
        }

        #cryptoReward {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            color: #ff0;
            font-size: 24px;
            text-shadow: 0 0 10px #ff0;
            opacity: 0;
            transition: opacity 0.5s;
            z-index: 5;
        }

        /* --- STYLE UNTUK LINK POWERED BY --- */
        #poweredByLink {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            color: #0f0;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            text-decoration: none;
            opacity: 0.6;
            transition: all 0.3s ease;
            z-index: 1; /* Pastikan tidak tertutup elemen lain */
        }

        #poweredByLink:hover {
            opacity: 1;
            text-shadow: 0 0 8px #0f0;
        }

    </style>
</head>
<body>
    
    <div id="pre-splash">
        <div class="powered-by-text">Powered by</div>
    </div>

    <div id="splash-screen">
        <img id="rialo-logo" src="rialoo.png" alt="Rialo Logo">
    </div>

    <div id="desktop-warning">
        <h1>This game can only be played in desktop mode</h1>
        <p>please open it on your computer or laptop for the best gaming experience.</p>
    </div>

    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="600"></canvas>

        <div id="uiOverlay" class="hidden">
            <div id="topUI">
                <div>SCORE: <span id="score">0</span></div>
                <div>LEVEL: <span id="level">1</span></div>
                <div>MULTIPLIER: <span id="multiplier">x1</span></div>
            </div>
            
            <div id="bossUIContainer" class="hidden">
                <p>VOID COMMANDER</p>
                <div class="bossHealthBar">
                    <div id="bossHealthFill"></div>
                </div>
            </div>

            <div id="healthContainer" class="uiBarContainer">
                <p>HP</p>
                <div class="uiBar">
                    <div id="healthFill"></div>
                </div>
            </div>

            <div id="ultimateContainer" class="uiBarContainer">
                <p>ULT</p>
                <div class="uiBar">
                    <div id="ultimateFill"></div>
                </div>
            </div>
            <div id="levelProgressUI"></div>
            <div id="powerUpUI"></div>
        </div>

        <div id="usernameMenu" class="hidden">
            <img src="latar.png" alt="Rialo Game Art" id="game-art">
            <input type="text" id="usernameInput" placeholder="Enter Username" maxlength="12">
            <button id="enterUsernameButton">ENTER</button>
        </div>

        <div id="gameStart" class="hidden">
            <h1>
                <img src="logorlo.png" alt="Rialo Logo" class="h1-logo">
                RIALO
            </h1>
            <h1>Chain Blaster</h1>
            <p>Destroy asteroids and enemy ships to earn Rialo tokens!</p>
            <button id="startButton">START GAME</button>
            <div id="instructions">
                <p>CONTROLS:</p>
                <p>W/Up Arrow - Thrust Forward</p>
                <p>S/Down Arrow - Thrust Backward</p>
                <p>A/D or Left/Right Arrows - Rotate</p>
                <p>Spacebar - Shoot</p>
                <p>Shift - Activate Ultimate (when bar is full)</p>
            </div>
        </div>

        <div id="gameOver" class="hidden">
            <h1>GAME OVER</h1>
            <p>Final Score: <span id="finalScore">0</span></p>
            <p>Rialo Tokens Earned: <span id="tokensEarned">0</span></p>
            <button id="restartButton">PLAY AGAIN</button>
            <button id="exitButton">EXIT</button>
        </div>

        <div id="cryptoReward">
            Rialo Token Unlocked!
        </div>
    </div>
    
    <a href="https://www.rialo.io/" target="_blank" id="poweredByLink">Powered by Rialo</a>

    <audio id="bgMusic" src="asteroid.mp3" loop></audio>
    <audio id="gameOverSound" src="gameover.mp3"></audio>

    <script>
        // --- Intro, Splash Screen, and Game Init Logic ---
        window.addEventListener('load', () => {
            const preSplash = document.getElementById('pre-splash');
            const splashScreen = document.getElementById('splash-screen');
            const rialoLogo = document.getElementById('rialo-logo');
            const gameContainer = document.getElementById('gameContainer');

            // --- Intro Animation Sequence ---

            // 1. Show "Powered by" then hide after 2 seconds
            setTimeout(() => {
                preSplash.classList.add('hidden');
                
                // 2. After "Powered by" starts fading, show the Rialo logo screen
                splashScreen.classList.add('visible');
                // and trigger the logo animation
                rialoLogo.classList.add('animate');

            }, 2000); // Duration of "Powered by" screen

            // 3. Hide the logo screen after a total of 4 seconds (2s + 2s)
            setTimeout(() => {
                splashScreen.classList.add('hidden');
                
                // 4. After the logo screen fades, show the game container and username menu
                splashScreen.addEventListener('transitionend', () => {
                    preSplash.style.display = 'none';
                    splashScreen.style.display = 'none';
                    gameContainer.classList.add('visible');
                    // MODIFIED: Show username menu first
                    document.getElementById('usernameMenu').classList.remove('hidden');
                    initGame();
                }, { once: true });

            }, 4000); // Total intro duration = 2s (Powered by) + 2s (Logo)
        });


        // --- Game Setup ---
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Muat semua gambar yang dibutuhkan
        const playerImage = new Image();
        playerImage.src = 'jet.png';

        const bigAsteroidImage = new Image();
        bigAsteroidImage.src = 'big.png';

        const smallAsteroidImage = new Image();
        smallAsteroidImage.src = 'small.png';
        
        const enemyImage = new Image();
        enemyImage.src = 'musuh.png';
        
        const ultimatumImage = new Image();
        ultimatumImage.src = 'item.png';

        const bossImage = new Image();
        bossImage.src = 'bos.png';

        // --- NEW: Load Health Boost Image ---
        const heartImage = new Image();
        heartImage.src = 'heart.png'; // Pastikan Anda punya file 'heart.png'

        const bgMusic = document.getElementById('bgMusic');
        const gameOverSound = document.getElementById('gameOverSound');


        // --- Game State Variables ---
        let gameActive = false;
        let score = 0;
        let level = 1;
        let multiplier = 1;
        let health = 100;
        let asteroidsDestroyedThisLevel = 0;
        let asteroidsNeededForNextLevel = 10;
        let username = 'Player';
        let isBossLevel = false;
        let boss = null;
        let bossesDefeated = 0;

        // --- NEW: Ultimate Skill Variables ---
        let ultimateCharge = 0;
        const ULTIMATE_CHARGE_NEEDED = 30;

        // --- Game Objects ---
        let asteroids = [];
        let enemyShips = [];
        let particles = [];
        let enemyBullets = [];
        let powerUps = [];
        let homingBombs = []; // Array for ultimate skill projectiles

        // --- Player Configuration ---
        const PLAYER_SETTINGS = {
            size: 20,
            thrust: 0.1,
            rotationSpeed: 0.08,
            friction: 0.98,
            shootDelay: 200,
        };

        const player = {
            x: canvas.width / 2,
            y: canvas.height / 2,
            size: PLAYER_SETTINGS.size,
            angle: -Math.PI / 2,
            velocity: { x: 0, y: 0 },
            bullets: [],
            lastShot: 0,
            activePowerUp: 'none',
            powerUpTimer: 0,
            baseShootDelay: PLAYER_SETTINGS.shootDelay,
            isInvincible: false,
            invincibilityTimer: 0
        };

        // --- Input Handling ---
        const keys = {
            w: false, s: false, a: false, d: false,
            ArrowUp: false, ArrowDown: false, ArrowLeft: false, ArrowRight: false,
            ' ': false, Shift: false
        };

        function handleKeyDown(e) {
            if (keys.hasOwnProperty(e.key)) keys[e.key] = true;
            if (e.key === ' ') shoot();
            // --- NEW: Activate Ultimate ---
            if (e.key === 'Shift') activateUltimate();
        }

        function handleKeyUp(e) {
            if (keys.hasOwnProperty(e.key)) keys[e.key] = false;
        }
        
        function returnToStartMenu() {
            document.getElementById('gameOver').classList.add('hidden');
            document.getElementById('gameStart').classList.remove('hidden');
        }

        // --- Game Initialization ---
        function initGame() {
            document.getElementById('enterUsernameButton').addEventListener('click', () => {
                const input = document.getElementById('usernameInput');
                if (input.value.trim() !== '') {
                    username = input.value.trim();
                }
                document.getElementById('usernameMenu').classList.add('hidden');
                document.getElementById('gameStart').classList.remove('hidden');
            });

            document.getElementById('startButton').addEventListener('click', startGame);
            document.getElementById('restartButton').addEventListener('click', startGame);
            document.getElementById('exitButton').addEventListener('click', returnToStartMenu);
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keyup', handleKeyUp);
        }

        // --- Game Start/Reset ---
        function startGame() {
            gameActive = true;
            score = 0;
            level = 1;
            multiplier = 1;
            health = 100;
            ultimateCharge = 0; // Reset ultimate
            asteroidsDestroyedThisLevel = 0;
            asteroidsNeededForNextLevel = 10;
            isBossLevel = false; 
            boss = null;
            bossesDefeated = 0;

            player.x = canvas.width / 2;
            player.y = canvas.height / 2;
            player.velocity = { x: 0, y: 0 };
            player.angle = -Math.PI / 2;
            player.bullets = [];
            player.activePowerUp = 'none';
            player.powerUpTimer = 0;
            player.isInvincible = false;
            player.invincibilityTimer = 0;
            PLAYER_SETTINGS.shootDelay = player.baseShootDelay;

            asteroids = [];
            enemyShips = [];
            particles = [];
            enemyBullets = [];
            powerUps = [];
            homingBombs = []; // Reset bombs

            for (let i = 0; i < 5 + level; i++) {
                createAsteroid();
            }

            document.getElementById('gameStart').classList.add('hidden');
            document.getElementById('gameOver').classList.add('hidden');
            document.getElementById('uiOverlay').classList.remove('hidden');
            document.getElementById('bossUIContainer').classList.add('hidden');

            lastTime = 0;
            updateUI();
            
            bgMusic.currentTime = 0; 
            bgMusic.play();
            
            requestAnimationFrame(gameLoop);
        }
        
        let lastTime = 0;

        // --- Main Game Loop ---
        function gameLoop(timestamp) {
            if (!gameActive) return;

            const deltaTime = (timestamp - (lastTime || timestamp)) / 1000;
            lastTime = timestamp;

            ctx.fillStyle = 'black';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            updatePlayer(deltaTime);
            updateBullets(player.bullets); 
            updateBullets(enemyBullets);
            updateParticles();
            updatePowerUps(deltaTime);
            updateHomingBombs(); // Update ultimate bombs

            if (isBossLevel) {
                if (boss) {
                    updateBoss(deltaTime);
                    drawBoss();
                }
            } else {
                updateAsteroids();
                updateEnemies();
                drawAsteroids();
                drawEnemies();

                if (asteroids.length < 3 + level && Math.random() < 0.02) {
                    createAsteroid();
                }
                
                const maxEnemies = 1 + bossesDefeated;
                if (!isBossLevel && enemyShips.length < maxEnemies && Math.random() < 0.005) {
                    createEnemyShip();
                }

                 if (asteroidsDestroyedThisLevel >= asteroidsNeededForNextLevel) levelUp();
            }

            checkCollisions();

            drawPlayer();
            drawBullets(player.bullets, '#0ff');
            drawBullets(enemyBullets, '#f55');
            drawParticles();
            drawPowerUps();
            drawHomingBombs(); // Draw ultimate bombs

            updateUI();

            if (health <= 0) {
                gameOver();
                return;
            }

            requestAnimationFrame(gameLoop);
        }

        // --- Update Functions ---
        function updatePlayer(deltaTime) {
            if (keys.a || keys.ArrowLeft) player.angle -= PLAYER_SETTINGS.rotationSpeed;
            if (keys.d || keys.ArrowRight) player.angle += PLAYER_SETTINGS.rotationSpeed;

            const currentThrust = PLAYER_SETTINGS.thrust;

            if (keys.w || keys.ArrowUp) {
                player.velocity.x += Math.cos(player.angle) * currentThrust;
                player.velocity.y += Math.sin(player.angle) * currentThrust;
            }
            if (keys.s || keys.ArrowDown) {
                player.velocity.x -= Math.cos(player.angle) * currentThrust * 0.5;
                player.velocity.y -= Math.sin(player.angle) * currentThrust * 0.5;
            }

            player.velocity.x *= PLAYER_SETTINGS.friction;
            player.velocity.y *= PLAYER_SETTINGS.friction;
            player.x += player.velocity.x;
            player.y += player.velocity.y;

            if (player.x < -player.size) player.x = canvas.width + player.size;
            if (player.x > canvas.width + player.size) player.x = -player.size;
            if (player.y < -player.size) player.y = canvas.height + player.size;
            if (player.y > canvas.height + player.size) player.y = -player.size;
            
            if (player.powerUpTimer > 0) {
                player.powerUpTimer -= deltaTime;
                if (player.powerUpTimer <= 0) {
                    deactivatePowerUp();
                }
            }
            
            if (player.isInvincible) {
                player.invincibilityTimer -= deltaTime;
                if (player.invincibilityTimer <= 0) {
                    player.isInvincible = false;
                }
            }
        }
        
        function updatePowerUps(deltaTime) {
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const p = powerUps[i];
                p.life -= deltaTime;
                if (p.life <= 0) {
                    powerUps.splice(i, 1);
                }
            }
        }

        function updateBullets(bulletArray) {
            const now = Date.now();
            for (let i = bulletArray.length - 1; i >= 0; i--) {
                const bullet = bulletArray[i];

                if (now - bullet.createdAt > 5000) {
                    bulletArray.splice(i, 1);
                    continue;
                }

                bullet.x += Math.cos(bullet.angle) * bullet.speed;
                bullet.y += Math.sin(bullet.angle) * bullet.speed;

                const shouldWrap = (bulletArray === player.bullets);
                if (shouldWrap) {
                    if (bullet.x < 0) bullet.x = canvas.width;
                    if (bullet.x > canvas.width) bullet.x = 0;
                    if (bullet.y < 0) bullet.y = canvas.height;
                    if (bullet.y > canvas.height) bullet.y = 0;
                } else {
                    if (bullet.x < -20 || bullet.x > canvas.width + 20 || bullet.y < -20 || bullet.y > canvas.height + 20) {
                        bulletArray.splice(i, 1);
                    }
                }
            }
        }

        function updateAsteroids() {
            asteroids.forEach(asteroid => {
                asteroid.x += Math.cos(asteroid.angle) * asteroid.speed;
                asteroid.y += Math.sin(asteroid.angle) * asteroid.speed;
                asteroid.rotation += asteroid.rotationSpeed;

                if (asteroid.x < -asteroid.size) asteroid.x = canvas.width + asteroid.size;
                if (asteroid.x > canvas.width + asteroid.size) asteroid.x = -asteroid.size;
                if (asteroid.y < -asteroid.size) asteroid.y = canvas.height + asteroid.size;
                if (asteroid.y > canvas.height + asteroid.size) asteroid.y = -asteroid.size;
            });
        }

        function updateEnemies() {
            const MIN_DISTANCE_FROM_PLAYER = 120; 

            for (let i = enemyShips.length - 1; i >= 0; i--) {
                const enemy = enemyShips[i];
                
                const dx = player.x - enemy.x;
                const dy = player.y - enemy.y;
                const distance = Math.sqrt(dx * dx + dy * dy);

                enemy.angle = Math.atan2(dy, dx);
                
                if (distance > MIN_DISTANCE_FROM_PLAYER) {
                    enemy.x += Math.cos(enemy.angle) * enemy.speed;
                    enemy.y += Math.sin(enemy.angle) * enemy.speed;
                }

                const now = Date.now();
                if (now - enemy.lastShot > enemy.shootDelay) {
                    enemy.lastShot = now;
                    enemyBullets.push({
                        x: enemy.x, y: enemy.y,
                        angle: enemy.angle, speed: 5, size: 3,
                        createdAt: Date.now()
                    });
                }
            }
        }
        
        function updateBoss(deltaTime) {
            const dx = player.x - boss.x;
            const dy = player.y - boss.y;
            boss.angle = Math.atan2(dy, dx);

            boss.x += Math.cos(boss.angle) * boss.speed;
            boss.y += Math.sin(boss.angle) * boss.speed;
            
            if (boss.x < -boss.size) boss.x = canvas.width + boss.size;
            if (boss.x > canvas.width + boss.size) boss.x = -boss.size;
            if (boss.y < -boss.size) boss.y = canvas.height + boss.size;
            if (boss.y > canvas.height + boss.size) boss.y = -boss.size;

            const now = Date.now();

            if (now - boss.lastSpecialAttack > boss.specialAttackCooldown) {
                boss.lastSpecialAttack = now;
                const spreadAngles = [-0.2, 0, 0.2];
                for (const angleOffset of spreadAngles) {
                    enemyBullets.push({
                        x: boss.x, y: boss.y, angle: boss.angle + angleOffset,
                        speed: 6, size: 12,
                        isBossBullet: true, 
                        createdAt: Date.now()
                    });
                }
            }
            
            else if (now - boss.lastShot > boss.shootDelay) {
                boss.lastShot = now;
                 enemyBullets.push({
                    x: boss.x, y: boss.y, angle: boss.angle, 
                    speed: 7, size: 10,
                    isBossBullet: true,
                    createdAt: Date.now()
                });
            }
        }

        function updateParticles() {
            for (let i = particles.length - 1; i >= 0; i--) {
                const p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life--;
                if (p.life <= 0) particles.splice(i, 1);
            }
        }
        
        // --- MODIFIED: Update Homing Fireballs ---
        function updateHomingBombs() {
            for (let i = homingBombs.length - 1; i >= 0; i--) {
                const bomb = homingBombs[i];
                
                const targetStillExists = asteroids.includes(bomb.target) || enemyShips.includes(bomb.target) || bomb.target === boss;
                if (!bomb.target || !targetStillExists) {
                    createExplosion(bomb.x, bomb.y, 20, '#ff8c00');
                    homingBombs.splice(i, 1);
                    continue;
                }

                const dx = bomb.target.x - bomb.x;
                const dy = bomb.target.y - bomb.y;
                const targetAngle = Math.atan2(dy, dx);
                
                let angleDiff = targetAngle - bomb.angle;
                while (angleDiff < -Math.PI) angleDiff += Math.PI * 2;
                while (angleDiff > Math.PI) angleDiff -= Math.PI * 2;
                bomb.angle += angleDiff * bomb.turnSpeed;

                bomb.x += Math.cos(bomb.angle) * bomb.speed;
                bomb.y += Math.sin(bomb.angle) * bomb.speed;

                // Emit fire particles for a trail effect
                if (Math.random() < 0.6) {
                    particles.push({
                        x: bomb.x, y: bomb.y,
                        vx: (Math.random() - 0.5) * 0.5, vy: (Math.random() - 0.5) * 0.5,
                        life: Math.random() * 15 + 5,
                        color: ['#ff8c00', '#ffa500', '#ff4500'][Math.floor(Math.random() * 3)],
                        size: Math.random() * 2 + 1
                    });
                }
            }
        }
        
        function checkCollisions() {
            // Player bullet collisions
            for (let i = player.bullets.length - 1; i >= 0; i--) {
                const bullet = player.bullets[i];
                let bulletRemoved = false;

                if (isBossLevel && boss && isColliding(bullet, boss)) {
                    boss.hp -= 10;
                    createExplosion(bullet.x, bullet.y, 10, '#c000ff');
                    player.bullets.splice(i, 1);
                    bulletRemoved = true;
                    if (boss.hp <= 0) {
                        defeatBoss();
                    }
                    continue;
                }
                
                for (let j = asteroids.length - 1; j >= 0; j--) {
                    const asteroid = asteroids[j];
                    if (isColliding(bullet, asteroid)) {
                        createExplosion(asteroid.x, asteroid.y, asteroid.size, '#f90');
                        player.bullets.splice(i, 1);
                        bulletRemoved = true;
                        
                        if (Math.random() < 0.15) {
                            createPowerUp(asteroid.x, asteroid.y);
                        }

                        if (asteroid.imageObject === bigAsteroidImage) {
                            for (let k = 0; k < 2; k++) { 
                                asteroids.push({
                                    x: asteroid.x, y: asteroid.y, 
                                    size: asteroid.size / 1.8,
                                    speed: asteroid.speed * 0.8, 
                                    angle: asteroid.angle + (k - 1) * 0.8,
                                    imageObject: smallAsteroidImage, rotation: 0,
                                    rotationSpeed: (Math.random() - 0.5) * 0.03
                                });
                            }
                        }

                        asteroids.splice(j, 1);
                        asteroidsDestroyedThisLevel++;
                        score += 100 * multiplier;
                        if (ultimateCharge < ULTIMATE_CHARGE_NEEDED) {
                            ultimateCharge++;
                        }
                        break;
                    }
                }
                
                if (bulletRemoved) continue;

                for (let j = enemyShips.length - 1; j >= 0; j--) {
                    const enemy = enemyShips[j];
                    if (isColliding(bullet, enemy)) {
                        player.bullets.splice(i, 1);
                        createExplosion(enemy.x, enemy.y, enemy.size, '#f00');
                        enemyShips.splice(j, 1);
                        score += 250 * multiplier;
                        break;
                    }
                }
            }
            
            // --- MODIFIED: Homing fireball collisions ---
            for (let i = homingBombs.length - 1; i >= 0; i--) {
                const bomb = homingBombs[i];
                let bombHit = false;

                if (bomb.target && isColliding(bomb, bomb.target)) {
                    createExplosion(bomb.x, bomb.y, 50, '#ff8c00'); // Big orange explosion
                    
                    const asteroidIndex = asteroids.indexOf(bomb.target);
                    if (asteroidIndex > -1) {
                        asteroids.splice(asteroidIndex, 1);
                        score += 100 * multiplier;
                        asteroidsDestroyedThisLevel++;
                    }

                    const enemyIndex = enemyShips.indexOf(bomb.target);
                    if (enemyIndex > -1) {
                        enemyShips.splice(enemyIndex, 1);
                        score += 250 * multiplier;
                    }
                    
                    if (isBossLevel && bomb.target === boss) {
                        boss.hp -= 50;
                        if (boss.hp <= 0) defeatBoss();
                    }

                    homingBombs.splice(i, 1);
                    bombHit = true;
                }
            }

            // Player collision with environment/enemies
            if (!player.isInvincible) {
                if (isBossLevel && boss && isColliding(player, boss)) {
                    createExplosion(player.x, player.y, 20, '#f00');
                    health -= 15;
                    player.isInvincible = true;
                    player.invincibilityTimer = 3;
                }
                
                for (let i = asteroids.length - 1; i >= 0; i--) {
                    const asteroid = asteroids[i];
                    if (isColliding(player, asteroid)) {
                        createExplosion(asteroid.x, asteroid.y, asteroid.size, '#f90');
                        health -= 15;
                        asteroids.splice(i, 1);
                        player.isInvincible = true;
                        player.invincibilityTimer = 3; 
                        break; 
                    }
                }
                for (let i = enemyBullets.length - 1; i >= 0; i--) {
                    const bullet = enemyBullets[i];
                    if (isColliding(player, bullet)) {
                        createExplosion(player.x, player.y, 10, '#f55');
                        if (bullet.isBossBullet) health -= 20;
                        else health -= 10;
                        enemyBullets.splice(i, 1);
                        player.isInvincible = true;
                        player.invincibilityTimer = 3;
                        break;
                    }
                }
            }
            
            // Player collision with power-ups
            for (let i = powerUps.length - 1; i >= 0; i--) {
                const p = powerUps[i];
                if (isColliding(player, p)) {
                    activatePowerUp(p.type);
                    powerUps.splice(i, 1);
                }
            }
        }

        function isColliding(obj1, obj2) {
            const dx = obj1.x - obj2.x;
            const dy = obj1.y - obj2.y;
            const distance = Math.sqrt(dx * dx + dy * dy);
            const size1 = obj1.collisionRadius || obj1.size || 3;
            const size2 = obj2.collisionRadius || obj2.size || 3;
            return distance < size1 + size2;
        }

        // --- Creation Functions ---
        function createAsteroid() {
            let size, imageObject, speed;
            if (Math.random() > 0.4) { 
                size = Math.random() * 20 + 40; 
                imageObject = bigAsteroidImage;
                speed = Math.random() * 1 + 0.5;
            } else { 
                size = Math.random() * 15 + 20; 
                imageObject = smallAsteroidImage;
                speed = Math.random() * 0.5 + 0.3;
            }
            let x, y;
            if (Math.random() < 0.5) {
                x = Math.random() < 0.5 ? -size : canvas.width + size; y = Math.random() * canvas.height;
            } else {
                x = Math.random() * canvas.width; y = Math.random() < 0.5 ? -size : canvas.height + size;
            }
            asteroids.push({
                x, y, size, imageObject, speed: speed,
                angle: Math.random() * Math.PI * 2, rotation: 0,
                rotationSpeed: (Math.random() - 0.5) * 0.02
            });
        }
        
        function createPowerUp(x, y, forcedType = null) {
            let type;
            if (forcedType) {
                type = forcedType;
            } else {
                const rand = Math.random();
                if (rand < 0.10) { type = 'ultimatum'; } 
                else if (rand < 0.40) { type = 'health-boost'; }
                else if (rand < 0.50) { type = 'triple-shot'; } 
                else { type = 'rapid-fire'; }
            }
            
            const itemSize = (type === 'health-boost') ? 16 : (type === 'ultimatum') ? 20 : 12;
            powerUps.push({ x, y, type, size: itemSize, life: 10 });
        }
        
        function createEnemyShip() {
            const size = 15;
            let x, y;
            if (Math.random() < 0.5) {
                x = Math.random() < 0.5 ? -size : canvas.width + size; y = Math.random() * canvas.height;
            } else {
                x = Math.random() * canvas.width; y = Math.random() < 0.5 ? -size : canvas.height + size;
            }
            enemyShips.push({
                x, y, size, collisionRadius: 25, speed: Math.random() * 1.5 + 0.5,
                angle: 0, lastShot: 0, shootDelay: 1500 - (level * 50)
            });
        }

        function createExplosion(x, y, size, baseColor) {
            const particleCount = Math.floor(size * 1.5);
            const colors = [baseColor, '#f90', '#ff0', '#fff'];
            for (let i = 0; i < particleCount; i++) {
                particles.push({
                    x, y, vx: (Math.random() - 0.5) * 6, vy: (Math.random() - 0.5) * 6,
                    life: Math.random() * 30 + 20, color: colors[Math.floor(Math.random() * colors.length)],
                    size: Math.random() * 3 + 1
                });
            }
        }

        // --- Drawing Functions ---
        function drawPlayer() {
            const shouldBlink = player.isInvincible && Math.floor(player.invincibilityTimer * 10) % 2 === 0;
            if (shouldBlink) return;

            ctx.save();
            ctx.translate(player.x, player.y);
            ctx.rotate(player.angle + Math.PI / 2);
            const playerWidth = player.size * 2.5; const playerHeight = player.size * 2.5;
            ctx.drawImage(playerImage, -playerWidth / 2, -playerHeight / 2, playerWidth, playerHeight);

            if (keys.w || keys.ArrowUp) {
                const flameColor = '#f90';
                ctx.fillStyle = flameColor; ctx.shadowColor = flameColor; ctx.shadowBlur = 15;
                const flameWidth = player.size * 0.5; const flameHeight = player.size * (1 + Math.random() * 0.5);
                ctx.fillRect(-flameWidth / 2, playerHeight / 2 - 5, flameWidth, flameHeight);
            }
            ctx.restore();
        }

        function drawAsteroids() {
            asteroids.forEach(asteroid => {
                ctx.save();
                ctx.translate(asteroid.x, asteroid.y);
                ctx.rotate(asteroid.rotation);
                const asteroidDiameter = asteroid.size * 2;
                ctx.drawImage(asteroid.imageObject, -asteroid.size, -asteroid.size, asteroidDiameter, asteroidDiameter);
                ctx.restore();
            });
        }
        
        function drawPowerUps() {
            powerUps.forEach(p => {
                ctx.save();
                ctx.translate(p.x, p.y);
                ctx.globalAlpha = p.life / 10;
                
                if (p.type === 'ultimatum') {
                    const pulse = Math.sin(Date.now() / 250); const glowSize = 15 + (pulse * 5);
                    ctx.shadowColor = '#0ff'; ctx.shadowBlur = glowSize;
                    const itemDiameter = p.size * 2.5; 
                    ctx.drawImage(ultimatumImage, -itemDiameter / 2, -itemDiameter / 2, itemDiameter, itemDiameter);
                } else if (p.type === 'health-boost') {
                    const pulse = Math.sin(Date.now() / 200) * 0.1 + 1;
                    const itemSize = p.size * 2 * pulse;
                    ctx.shadowColor = '#f00'; ctx.shadowBlur = 15;
                    ctx.drawImage(heartImage, -itemSize / 2, -itemSize / 2, itemSize, itemSize);
                } else {
                    ctx.font = 'bold 14px Courier New'; ctx.textAlign = 'center'; ctx.textBaseline = 'middle';
                    let text = '';
                    if (p.type === 'rapid-fire') { ctx.fillStyle = '#ff0'; text = 'RF'; } 
                    else if (p.type === 'triple-shot') { ctx.fillStyle = '#0ff'; text = 'TS'; }
                    ctx.shadowColor = ctx.fillStyle; ctx.shadowBlur = 15;
                    ctx.fillText(text, 0, 0);
                    ctx.strokeStyle = ctx.fillStyle; ctx.lineWidth = 2;
                    ctx.beginPath(); ctx.arc(0, 0, p.size, 0, Math.PI * 2); ctx.stroke();
                }
                ctx.restore();
            });
        }

        function drawEnemies() {
            enemyShips.forEach(enemy => {
                ctx.save();
                ctx.translate(enemy.x, enemy.y);
                ctx.rotate(enemy.angle + Math.PI / 2);
                const enemyWidth = enemy.size * 3.5; const enemyHeight = enemy.size * 3.5;
                ctx.drawImage(enemyImage, -enemyWidth / 2, -enemyHeight / 2, enemyWidth, enemyHeight);
                ctx.restore();
            });
        }
        
        function drawBoss() {
            ctx.save();
            ctx.translate(boss.x, boss.y);
            ctx.rotate(boss.angle + Math.PI / 2);
            const bossWidth = boss.size * 5; const bossHeight = boss.size * 5;
            ctx.shadowColor = '#c000ff'; ctx.shadowBlur = 20;
            ctx.drawImage(bossImage, -bossWidth / 2, -bossHeight / 2, bossWidth, bossHeight);
            ctx.restore();
        }

        function drawBullets(bulletArray, defaultColor) {
            bulletArray.forEach(bullet => {
                ctx.save();
                if (bullet.isBossBullet) {
                    const glowColor = '#ff4500';
                    ctx.fillStyle = glowColor;
                    ctx.shadowBlur = 25;
                    ctx.shadowColor = glowColor;
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2);
                    ctx.fill();
                } else {
                    ctx.fillStyle = defaultColor;
                    ctx.shadowBlur = 8;
                    ctx.shadowColor = defaultColor;
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, 3, 0, Math.PI * 2);
                    ctx.fill();
                }
                ctx.restore();
            });
        }

        function drawParticles() {
            particles.forEach(p => {
                ctx.save();
                ctx.globalAlpha = p.life / 50; ctx.fillStyle = p.color;
                ctx.beginPath(); ctx.arc(p.x, p.y, p.size, 0, Math.PI * 2); ctx.fill();
                ctx.restore();
            });
        }

        // --- MODIFIED: Draw Homing Fireballs ---
        function drawHomingBombs() {
            homingBombs.forEach(bomb => {
                ctx.save();
                ctx.fillStyle = '#ff4500'; // OrangeRed
                ctx.shadowBlur = 20;
                ctx.shadowColor = '#ffcc00'; // Yellowish glow
                
                ctx.beginPath();
                ctx.arc(bomb.x, bomb.y, bomb.size, 0, Math.PI * 2);
                ctx.fill();
                ctx.restore();
            });
        }

        // --- Game Logic Functions ---
        function shoot() {
            if (!gameActive) return;
            const now = Date.now();
            if (now - player.lastShot > PLAYER_SETTINGS.shootDelay) {
                player.lastShot = now;
                const baseBullet = {
                    x: player.x + Math.cos(player.angle) * player.size,
                    y: player.y + Math.sin(player.angle) * player.size,
                    speed: 10, size: 3, createdAt: Date.now()
                };

                if (player.activePowerUp === 'triple-shot') {
                    player.bullets.push({ ...baseBullet, angle: player.angle });
                    player.bullets.push({ ...baseBullet, angle: player.angle - 0.2 });
                    player.bullets.push({ ...baseBullet, angle: player.angle + 0.2 });
                } else {
                    player.bullets.push({ ...baseBullet, angle: player.angle });
                }
            }
        }
        
        function activateUltimatum() {
            asteroids.forEach(a => createExplosion(a.x, a.y, a.size, '#8a2be2'));
            score += asteroids.length * 100 * multiplier;
            asteroids = [];

            enemyShips.forEach(e => createExplosion(e.x, e.y, e.size, '#00ffff'));
            score += enemyShips.length * 250 * multiplier;
            enemyShips = [];
        }
        
        // --- MODIFIED: Activate Ultimate Skill ---
        function activateUltimate() {
            if (ultimateCharge < ULTIMATE_CHARGE_NEEDED || !gameActive) return;

            let targets = [...asteroids, ...enemyShips];
            if (isBossLevel && boss) {
                targets.push(boss);
            }
            if (targets.length === 0) return;

            // Fire exactly 6 fireballs
            for (let i = 0; i < 6; i++) {
                // Assign a target to each fireball, cycling through the target list
                const target = targets[i % targets.length];
                homingBombs.push({
                    x: player.x,
                    y: player.y,
                    target: target,
                    speed: 7, // A bit faster
                    turnSpeed: 0.08,
                    angle: player.angle + (Math.random() - 0.5), // Slight random spread
                    size: 7
                });
            }
            
            createExplosion(player.x, player.y, 40, '#ff8c00'); // Fiery activation explosion
            
            ultimateCharge = 0;
        }

        function activatePowerUp(type) {
            deactivatePowerUp();

            if (type === 'ultimatum') {
                activateUltimatum(); return;
            }
            
            if (type === 'health-boost') {
                health += 25;
                if (health > 100) health = 100;
                createExplosion(player.x, player.y, 20, '#0f0');
                return;
            }
            
            player.activePowerUp = type;
            player.powerUpTimer = 10;
            if (type === 'rapid-fire') { PLAYER_SETTINGS.shootDelay = 80; }
        }

        function deactivatePowerUp() {
            player.activePowerUp = 'none';
            PLAYER_SETTINGS.shootDelay = player.baseShootDelay;
        }

        function spawnBoss() {
            const baseHp = 150; const hpPerLevel = 25; 
            const bossMaxHp = baseHp + (level * hpPerLevel);
            boss = {
                x: canvas.width / 2, y: 120, size: 30, collisionRadius: 60,
                speed: 0.5, angle: 0, hp: bossMaxHp, maxHp: bossMaxHp,
                lastShot: Date.now(), shootDelay: 3000, 
                lastSpecialAttack: Date.now(), specialAttackCooldown: 10000
            };
        }
        
        function defeatBoss() {
            createExplosion(boss.x, boss.y, boss.size * 5, '#ff00ff');
            score += 5000 * multiplier;
            createPowerUp(boss.x, boss.y, 'ultimatum');
            
            health += 50;
            if (health > 100) health = 100;
            createExplosion(player.x, player.y, 30, '#0f0');

            bossesDefeated++;
            boss = null; isBossLevel = false;
            document.getElementById('bossUIContainer').classList.add('hidden');
            levelUp(); 
        }

        function levelUp() {
            level++; multiplier++;
            
            if (level % 5 === 0) {
                isBossLevel = true; asteroids = []; enemyShips = [];
                spawnBoss();
                document.getElementById('bossUIContainer').classList.remove('hidden');
            } else {
                isBossLevel = false;
                asteroidsDestroyedThisLevel = 0;
                asteroidsNeededForNextLevel += 5;
                createExplosion(player.x, player.y, 40, '#0ff');
                if (level % 5 === 1 && level > 1) { 
                    for(let i=0; i<3; i++) createAsteroid();
                }
            }
            
            if (level % 5 !== 0 && level % 6 !== 0) {
                showCryptoReward();
            }
        }

        function showCryptoReward() {
            const rewardElement = document.getElementById('cryptoReward');
            rewardElement.style.opacity = 1;
            setTimeout(() => { rewardElement.style.opacity = 0; }, 2000);
        }

        function updateUI() {
            document.getElementById('score').textContent = score;
            document.getElementById('level').textContent = level;
            document.getElementById('multiplier').textContent = `x${multiplier}`;
            document.getElementById('healthFill').style.width = `${health}%`;

            // --- MODIFIED: Update Ultimate Bar ---
            const ultPercent = (ultimateCharge / ULTIMATE_CHARGE_NEEDED) * 100;
            const ultFill = document.getElementById('ultimateFill');
            ultFill.style.width = `${ultPercent}%`;
            // Add a glow effect when the ultimate is ready
            if (ultPercent >= 100) {
                ultFill.style.boxShadow = "0 0 25px #ff8c00";
            } else {
                ultFill.style.boxShadow = "0 0 10px #ff8c00";
            }
            
            if (isBossLevel && boss) {
                const bossHealthPercent = Math.max(0, (boss.hp / boss.maxHp) * 100);
                document.getElementById('bossHealthFill').style.width = `${bossHealthPercent}%`;
                document.getElementById('levelProgressUI').textContent = `DEFEAT THE COMMANDER!`;
            } else {
                 document.getElementById('levelProgressUI').textContent = `ASTEROIDS DESTROYED: ${asteroidsDestroyedThisLevel} / ${asteroidsNeededForNextLevel}`;
            }

            const powerUpUI = document.getElementById('powerUpUI');
            if (player.powerUpTimer > 0) {
                const powerUpName = player.activePowerUp.replace('-', ' ').toUpperCase();
                powerUpUI.textContent = `${powerUpName}: ${Math.ceil(player.powerUpTimer)}s`;
            } else {
                powerUpUI.textContent = '';
            }
        }

        function gameOver() {
            gameActive = false;
            document.getElementById('uiOverlay').classList.add('hidden');
            bgMusic.pause(); gameOverSound.currentTime = 0; gameOverSound.play(); 
            const tokensEarned = Math.floor(score / 5000);
            document.getElementById('finalScore').textContent = score;
            document.getElementById('tokensEarned').textContent = tokensEarned;
            document.getElementById('gameOver').classList.remove('hidden');
        }
    </script>
</body>
</html>
